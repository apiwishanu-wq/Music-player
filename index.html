<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Music Player (Admin Demo)</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f7fa; margin: 0; padding: 0; }
    .player-container { max-width: 600px; margin: 40px auto; background: white; padding: 24px 32px 32px; border-radius: 12px; box-shadow: 0 2px 12px #0001; }
    h2, h3, h4 { margin-top: 0; }
    .playlist-item { padding: 6px 0; cursor: pointer; border-bottom: 1px solid #eee; }
    .playlist-item.active { background: #eaeaea; font-weight: bold;}
    #adminSection { margin-top:30px; padding:15px; background:#f9fafb; border-radius:10px; border:1px solid #ddd; }
    #broadcastMsg { margin-top:20px; background:#fefcbf; color:#744210; padding:10px; border-radius:6px; }
    .btn { padding:3px 10px; border-radius:4px; border:none; background:#c6e2ff; cursor:pointer; }
    .btn-danger { background: #ffb3b3; color:#900; }
    .btn-sm { font-size: 0.9em; }
    .input { padding:3px 7px; font-size:1em; }
    .flex { display:flex; align-items:center; gap:8px; }
    .chat-box { border:1px solid #ddd; background:#fafbfc; border-radius:7px; padding:8px; max-height:150px; overflow-y:auto; margin-bottom:8px; }
    .chat-msg { margin:4px 0; }
    .chat-user { font-weight:bold; color:#1b4c7a; }
    .chat-admin { color:#ad4400; }
    .signup-section { margin-bottom: 24px; }
    .link-btn { background:none; border:none; color:#1b4c7a; text-decoration:underline; cursor:pointer; font-size:1em; }
  </style>
</head>
<body>
  <div class="player-container" id="playerContainer">
    <h2>Music Player</h2>

    <!-- Login/Signup Section -->
    <div id="loginSection">
      <div class="flex">
        <input id="loginUsername" class="input" placeholder="Username">
        <input id="loginPassword" class="input" type="password" placeholder="Password">
        <button id="loginBtn" class="btn">Login</button>
        <button id="showSignupBtn" class="link-btn">Sign up</button>
      </div>
      <div id="loginError" style="color:red; margin-top:6px;"></div>
    </div>
    <div id="signupSection" class="signup-section" style="display:none;">
      <div class="flex">
        <input id="signupUsername" class="input" placeholder="Username">
        <input id="signupPassword" class="input" type="password" placeholder="Password">
        <input id="signupEmail" class="input" placeholder="Email (optional)">
        <button id="signupBtn" class="btn">Sign up</button>
        <button id="showLoginBtn" class="link-btn">Back to Login</button>
      </div>
      <div id="signupError" style="color:red; margin-top:6px;"></div>
      <div id="signupSuccess" style="color:green; margin-top:6px;"></div>
    </div>
    <div id="userSection" style="display:none;">
      <span id="welcomeMsg"></span>
      <button id="logoutBtn" class="btn btn-sm" style="float:right;">Logout</button>
    </div>

    <!-- Broadcast message for all users -->
    <div id="broadcastMsg" style="display:none;"></div>

    <hr>
    <h3>Now Playing</h3>
    <iframe id="videoPlayer" width="100%" height="315" src="" frameborder="0" allowfullscreen></iframe>

    <h4>Playlist</h4>
    <div id="playlistContainer"></div>

    <!-- Song Request/Addition Section -->
    <div id="requestSongSection" style="margin-top:15px; display:none;">
      <input id="requestSongInput" class="input" placeholder="Request a song (YouTube link or title)">
      <button id="requestSongBtn" class="btn">Request Song</button>
      <span id="requestStatus" style="color:green; margin-left:10px;"></span>
    </div>
    <div id="addSongSection" style="margin-top:15px; display:none;">
      <input id="youtubeUrl" class="input" placeholder="YouTube URL">
      <button id="addUrlBtn" class="btn">Add</button>
    </div>

    <!-- Chat Section -->
    <div style="margin-top: 28px;">
      <h4>Chat with Admin</h4>
      <div id="chatBox" class="chat-box"></div>
      <div class="flex">
        <input id="chatInput" class="input" placeholder="Type a message...">
        <button id="chatSendBtn" class="btn btn-sm">Send</button>
      </div>
    </div>

    <!-- Admin Dashboard Section -->
    <div id="adminSection" style="display:none;">
      <h3>Admin Dashboard</h3>

      <!-- User Management -->
      <div>
        <h4>User Management</h4>
        <ul id="userList"></ul>
      </div>

      <!-- Playlist Management -->
      <div>
        <h4>Playlist Management</h4>
        <ul id="adminPlaylist"></ul>
      </div>

      <!-- Pending Song Requests -->
      <div>
        <h4>Song Requests</h4>
        <ul id="adminRequests"></ul>
      </div>

      <!-- Split Chat With Users -->
      <div>
        <h4>Chats With Users</h4>
        <select id="adminChatSelect"></select>
        <div id="adminChatBox" class="chat-box"></div>
        <div class="flex">
          <input id="adminChatInput" class="input" placeholder="Type a message...">
          <button id="adminChatSendBtn" class="btn btn-sm">Send</button>
        </div>
      </div>

      <!-- Broadcast Message -->
      <div style="margin-top:18px;">
        <h4>Broadcast Message</h4>
        <input type="text" id="broadcastInput" placeholder="Message to all users" style="width:70%;" class="input" />
        <button id="broadcastBtn" class="btn btn-sm">Send</button>
        <span id="broadcastStatus" style="color:green; margin-left:10px;"></span>
      </div>
    </div>
  </div>
  <script>
    // --- Initial Demo Data ---
    let users = [
      { username: 'admin boon', password: 'boon42622', email: 'apiwish.a@gmail.com' },
      { username: 'alice', password: 'alice', email: 'alice@email.com' },
      { username: 'bob', password: 'bob', email: 'bob@email.com' }
    ];
    let playlist = [];
    let currentTrack = 0;
    let currentUser = null;
    let broadcastMessage = '';
    let songRequests = [];
    // Split chat: { [username]: [{sender, text}] }
    let chatMessages = {};

    // --- Elements ---
    const loginSection = document.getElementById('loginSection');
    const loginBtn = document.getElementById('loginBtn');
    const loginUsername = document.getElementById('loginUsername');
    const loginPassword = document.getElementById('loginPassword');
    const loginError = document.getElementById('loginError');
    // Signup
    const signupSection = document.getElementById('signupSection');
    const signupUsername = document.getElementById('signupUsername');
    const signupPassword = document.getElementById('signupPassword');
    const signupEmail = document.getElementById('signupEmail');
    const signupBtn = document.getElementById('signupBtn');
    const showSignupBtn = document.getElementById('showSignupBtn');
    const showLoginBtn = document.getElementById('showLoginBtn');
    const signupError = document.getElementById('signupError');
    const signupSuccess = document.getElementById('signupSuccess');

    const userSection = document.getElementById('userSection');
    const welcomeMsg = document.getElementById('welcomeMsg');
    const logoutBtn = document.getElementById('logoutBtn');
    const playlistContainer = document.getElementById('playlistContainer');
    const addUrlBtn = document.getElementById('addUrlBtn');
    const youtubeUrl = document.getElementById('youtubeUrl');
    const adminSection = document.getElementById('adminSection');
    const userList = document.getElementById('userList');
    const adminPlaylist = document.getElementById('adminPlaylist');
    const adminRequests = document.getElementById('adminRequests');
    const broadcastInput = document.getElementById('broadcastInput');
    const broadcastBtn = document.getElementById('broadcastBtn');
    const broadcastStatus = document.getElementById('broadcastStatus');
    const broadcastMsg = document.getElementById('broadcastMsg');
    const addSongSection = document.getElementById('addSongSection');
    const requestSongSection = document.getElementById('requestSongSection');
    const requestSongInput = document.getElementById('requestSongInput');
    const requestSongBtn = document.getElementById('requestSongBtn');
    const requestStatus = document.getElementById('requestStatus');

    // Chat
    const chatBox = document.getElementById('chatBox');
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');

    // Admin chat split
    const adminChatSelect = document.getElementById('adminChatSelect');
    const adminChatBox = document.getElementById('adminChatBox');
    const adminChatInput = document.getElementById('adminChatInput');
    const adminChatSendBtn = document.getElementById('adminChatSendBtn');

    // --- Signup Logic ---
    showSignupBtn.onclick = () => {
      loginSection.style.display = 'none';
      signupSection.style.display = '';
      signupError.textContent = '';
      signupSuccess.textContent = '';
    };
    showLoginBtn.onclick = () => {
      loginSection.style.display = '';
      signupSection.style.display = 'none';
      loginError.textContent = '';
    };
    signupBtn.onclick = () => {
      const username = signupUsername.value.trim();
      const password = signupPassword.value.trim();
      const email = signupEmail.value.trim();
      signupError.textContent = '';
      signupSuccess.textContent = '';
      if (!username || !password) {
        signupError.textContent = 'Username and password required.';
        return;
      }
      if (users.find(u => u.username === username)) {
        signupError.textContent = 'Username already exists.';
        return;
      }
      users.push({ username, password, email });
      signupSuccess.textContent = 'Signup successful! You can now login.';
      signupUsername.value = '';
      signupPassword.value = '';
      signupEmail.value = '';
    };

    // --- User Remember/Auto-login Logic ---
    function autoLogin() {
      const storedUser = localStorage.getItem('currentUser');
      if (storedUser) {
        currentUser = JSON.parse(storedUser);
        loginSection.style.display = 'none';
        signupSection.style.display = 'none';
        userSection.style.display = '';
        welcomeMsg.textContent = `Welcome, ${currentUser.username}!`;
        showUserUI();
      }
    }

    // --- Login Logic ---
    loginBtn.onclick = () => {
      const un = loginUsername.value.trim();
      const pw = loginPassword.value.trim();
      loginError.textContent = '';
      const found = users.find(u => u.username === un && u.password === pw);
      if (!found) {
        loginError.textContent = 'Invalid credentials';
        return;
      }
      currentUser = found;
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      loginSection.style.display = 'none';
      signupSection.style.display = 'none';
      userSection.style.display = '';
      welcomeMsg.textContent = `Welcome, ${currentUser.username}!`;
      showUserUI();
    };

    logoutBtn.onclick = () => {
      currentUser = null;
      localStorage.removeItem('currentUser');
      loginSection.style.display = '';
      signupSection.style.display = 'none';
      userSection.style.display = 'none';
      adminSection.style.display = 'none';
      addSongSection.style.display = 'none';
      requestSongSection.style.display = 'none';
      broadcastMsg.style.display = 'none';
      renderPlaylist();
      chatBox.innerHTML = '';
    };

    function showUserUI() {
      if (!currentUser) return;
      if (currentUser.username === 'admin') {
        addSongSection.style.display = '';
        requestSongSection.style.display = 'none';
        adminSection.style.display = 'block';
        renderUserList();
        renderAdminPlaylist();
        renderRequests();
        renderAdminChatSelect();
        renderAdminChat();
      } else {
        addSongSection.style.display = 'none';
        requestSongSection.style.display = '';
        adminSection.style.display = 'none';
        renderChat();
      }
      renderPlaylist();
      // Show broadcast if set
      if (broadcastMessage) {
        broadcastMsg.style.display = 'block';
        broadcastMsg.textContent = broadcastMessage;
      } else {
        broadcastMsg.style.display = 'none';
        broadcastMsg.textContent = '';
      }
    }

    // --- Playlist Logic (admin only) ---
    addUrlBtn.onclick = () => {
      const url = youtubeUrl.value.trim();
      if (!url) return;
      const id = getYouTubeId(url);
      if (!id) {
        alert('Invalid YouTube URL');
        return;
      }
      playlist.push({id, title: 'YouTube Video', addedBy: currentUser ? currentUser.username : 'unknown'});
      youtubeUrl.value = '';
      renderPlaylist();
      renderAdminPlaylist();
    };

    function getYouTubeId(url) {
      const match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?(?:.*&)?v=|embed\/|v\/))([\w-]{11})/);
      return match ? match[1] : null;
    }

    function renderPlaylist(){
      playlistContainer.innerHTML='';
      playlist.forEach((track,i)=>{
        const div=document.createElement('div');
        div.textContent=`${track.title} [by ${track.addedBy||'unknown'}]`;
        div.className='playlist-item'+(i===currentTrack?' active':'');
        // Only admin can select/play
        if (currentUser && currentUser.username === 'admin') {
          div.onclick=()=>{ playTrack(i); }
        }
        playlistContainer.appendChild(div);
      });
      // Play first track if nothing is playing and admin is logged in
      if (currentUser && currentUser.username === 'admin' && playlist.length && videoPlayer.src === '') {
        playTrack(0);
      }
      if (!currentUser || currentUser.username !== 'admin') {
        videoPlayer.src = '';
      }
    }

    function playTrack(idx) {
      if (!playlist[idx]) return;
      currentTrack = idx;
      videoPlayer.src = 'https://www.youtube.com/embed/' + playlist[idx].id + '?autoplay=1';
      renderPlaylist();
    }

    // --- Song Requests ---
    requestSongBtn.onclick = () => {
      const req = requestSongInput.value.trim();
      if (!req) return;
      songRequests.push({user: currentUser.username, request: req});
      requestStatus.textContent = 'Request sent!';
      requestSongInput.value = '';
      renderRequests();
      setTimeout(() => requestStatus.textContent = '', 2000);
    };

    function renderRequests() {
      if (!adminRequests) return;
      adminRequests.innerHTML = '';
      songRequests.forEach((sr, idx) => {
        const li = document.createElement('li');
        li.textContent = `${sr.user}: ${sr.request} `;
        const addBtn = document.createElement('button');
        addBtn.textContent = 'Add';
        addBtn.className = 'btn btn-sm';
        addBtn.onclick = () => {
          // If possible, try to extract YouTube ID
          const id = getYouTubeId(sr.request);
          playlist.push({
            id: id || '',
            title: id ? 'YouTube Video' : sr.request,
            addedBy: sr.user
          });
          songRequests.splice(idx, 1);
          renderRequests();
          renderAdminPlaylist();
          renderPlaylist();
        };
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Dismiss';
        delBtn.className = 'btn btn-danger btn-sm';
        delBtn.onclick = () => {
          songRequests.splice(idx, 1);
          renderRequests();
        };
        li.appendChild(addBtn);
        li.appendChild(delBtn);
        adminRequests.appendChild(li);
      });
    }

    // --- User Management (Admin Only) ---
    function renderUserList() {
      userList.innerHTML = '';
      users.forEach((user, idx) => {
        if (user.username === 'admin') return; // Don't allow deleting admin
        const li = document.createElement('li');
        li.textContent = `${user.username} (${user.email || 'no email'}) `;
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.className = "btn btn-danger btn-sm";
        delBtn.onclick = () => {
          users.splice(idx, 1);
          renderUserList();
        };
        li.appendChild(delBtn);
        userList.appendChild(li);
      });
    }

    // --- Playlist Management (Admin Only) ---
    function renderAdminPlaylist() {
      adminPlaylist.innerHTML = '';
      playlist.forEach((track, i) => {
        const li = document.createElement('li');
        li.textContent = `[${track.addedBy}] ${track.title} `;
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Remove';
        delBtn.className = "btn btn-danger btn-sm";
        delBtn.onclick = () => {
          playlist.splice(i, 1);
          renderAdminPlaylist();
          renderPlaylist();
        };
        li.appendChild(delBtn);
        adminPlaylist.appendChild(li);
      });
    }

    // --- Broadcast Message (Admin Only) ---
    broadcastBtn.onclick = () => {
      broadcastMessage = broadcastInput.value.trim();
      if (broadcastMessage) {
        broadcastStatus.textContent = "Message sent!";
        broadcastMsg.style.display = 'block';
        broadcastMsg.textContent = broadcastMessage;
      } else {
        broadcastStatus.textContent = '';
        broadcastMsg.style.display = 'none';
        broadcastMsg.textContent = '';
      }
      setTimeout(() => broadcastStatus.textContent = '', 2000);
    };

    // --- Split Chat Functionality ---
    function renderChat() {
      if (!currentUser) return;
      chatBox.innerHTML = '';
      const msgs = chatMessages[currentUser.username] || [];
      msgs.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'chat-msg';
        if (msg.sender === 'admin') {
          div.innerHTML = `<span class="chat-user chat-admin">Admin:</span> ${msg.text}`;
        } else {
          div.innerHTML = `<span class="chat-user">${msg.sender}:</span> ${msg.text}`;
        }
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    chatSendBtn.onclick = () => {
      if (!currentUser) return;
      const txt = chatInput.value.trim();
      if (!txt) return;
      if (!chatMessages[currentUser.username]) chatMessages[currentUser.username] = [];
      chatMessages[currentUser.username].push({sender: currentUser.username, text: txt});
      chatInput.value = '';
      renderChat();
      renderAdminChat();
    };

    // Admin: select user to chat with
    function renderAdminChatSelect() {
      // Show only users who have chatted or who exist (besides admin)
      adminChatSelect.innerHTML = '';
      users.forEach(u => {
        if (u.username === 'admin') return;
        const option = document.createElement('option');
        option.value = u.username;
        option.textContent = u.username + (chatMessages[u.username] && chatMessages[u.username].length > 0 ? ' (chatted)' : '');
        adminChatSelect.appendChild(option);
      });
    }

    adminChatSelect.onchange = renderAdminChat;
    function renderAdminChat() {
      const uname = adminChatSelect.value;
      adminChatBox.innerHTML = '';
      if (!uname) return;
      const msgs = chatMessages[uname] || [];
      msgs.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'chat-msg';
        if (msg.sender === 'admin') {
          div.innerHTML = `<span class="chat-user chat-admin">Admin:</span> ${msg.text}`;
        } else {
          div.innerHTML = `<span class="chat-user">${msg.sender}:</span> ${msg.text}`;
        }
        adminChatBox.appendChild(div);
      });
      adminChatBox.scrollTop = adminChatBox.scrollHeight;
    }

    adminChatSendBtn.onclick = () => {
      const uname = adminChatSelect.value;
      if (!uname) return;
      const txt = adminChatInput.value.trim();
      if (!txt) return;
      if (!chatMessages[uname]) chatMessages[uname] = [];
      chatMessages[uname].push({sender: 'admin', text: txt});
      adminChatInput.value = '';
      renderAdminChat();
      // If this user is logged in, update their chat view live
      if (currentUser && currentUser.username === uname) {
        renderChat();
      }
    };

    // --- Hide Add/Request Song Section for Non-logged-in Users ---
    addSongSection.style.display = 'none';
    requestSongSection.style.display = 'none';

    // --- Auto-login if user is remembered ---
    autoLogin();
  </script>
</body>
</html>
