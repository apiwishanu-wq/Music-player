<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>StreamVibe - Music Player</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0; padding: 0; min-height: 100vh;
    }
    
    .player-container { 
      max-width: 800px; margin: 20px auto; 
      background: rgba(255,255,255,0.95); 
      backdrop-filter: blur(10px);
      padding: 30px; border-radius: 20px; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      animation: slideIn 0.5s ease-out;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .logo { 
      text-align: center; margin-bottom: 30px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; color: transparent;
      font-size: 2.5em; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    
    .auth-section {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      padding: 25px; border-radius: 15px; margin-bottom: 20px;
      color: white; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .form-group { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .input { 
      padding: 12px 16px; border: none; border-radius: 25px; 
      font-size: 1em; background: rgba(255,255,255,0.9);
      transition: all 0.3s ease; outline: none; flex: 1; min-width: 120px;
    }
    .input:focus { 
      background: white; transform: scale(1.02);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .btn { 
      padding: 12px 24px; border-radius: 25px; border: none; 
      background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
      color: white; cursor: pointer; font-weight: 600;
      transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .btn:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 10px 20px rgba(79, 172, 254, 0.4);
    }
    .btn:active { transform: translateY(0); }
    
    .btn-danger { 
      background: linear-gradient(45deg, #ff416c 0%, #ff4b2b 100%);
    }
    .btn-danger:hover { 
      box-shadow: 0 10px 20px rgba(255, 65, 108, 0.4);
    }
    
    .btn-success {
      background: linear-gradient(45deg, #56ab2f 0%, #a8e6cf 100%);
    }
    
    .btn-sm { padding: 8px 16px; font-size: 0.9em; }
    
    .link-btn { 
      background: none; border: none; color: rgba(255,255,255,0.9); 
      text-decoration: underline; cursor: pointer; font-size: 1em;
      transition: color 0.3s ease;
    }
    .link-btn:hover { color: white; }
    
    .user-section {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      padding: 20px; border-radius: 15px; margin-bottom: 20px;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .welcome-msg { 
      font-size: 1.3em; font-weight: 600; 
      color: #2d3748; text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
    }
    
    .broadcast-msg { 
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      color: #8b4513; padding: 15px; border-radius: 12px; margin: 20px 0;
      border-left: 5px solid #ff8c00; animation: pulse 2s infinite;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    
    .video-container {
      position: relative; margin: 20px 0;
      background: #000; border-radius: 15px; overflow: hidden;
      box-shadow: 0 15px 30px rgba(0,0,0,0.3);
    }
    
    .video-container iframe {
      width: 100%; height: 400px; border: none;
    }
    
    .playlist-container {
      background: linear-gradient(135deg, #e3ffe7 0%, #d9e7ff 100%);
      border-radius: 15px; padding: 20px; margin: 20px 0;
      max-height: 300px; overflow-y: auto;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .playlist-item { 
      padding: 12px 16px; margin: 8px 0; cursor: pointer; 
      border-radius: 10px; transition: all 0.3s ease;
      background: rgba(255,255,255,0.7);
      border-left: 4px solid transparent;
    }
    .playlist-item:hover { 
      background: rgba(255,255,255,0.9); 
      transform: translateX(5px);
      border-left-color: #667eea;
    }
    .playlist-item.active { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; font-weight: 600;
      border-left-color: #fff;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .song-section {
      background: linear-gradient(135deg, #fff5f5 0%, #f0fff4 100%);
      padding: 20px; border-radius: 15px; margin: 20px 0;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .chat-section {
      background: linear-gradient(135deg, #f8f9ff 0%, #fff8f8 100%);
      padding: 20px; border-radius: 15px; margin: 20px 0;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .chat-box { 
      background: white; border: 2px solid #e2e8f0; 
      border-radius: 12px; padding: 15px; max-height: 200px; 
      overflow-y: auto; margin-bottom: 15px;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .chat-msg { 
      margin: 8px 0; padding: 8px 12px; border-radius: 8px;
      background: rgba(102, 126, 234, 0.1);
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .chat-user { font-weight: 600; }
    .chat-admin { color: #e53e3e; }
    .chat-timestamp { color: #718096; font-size: 0.8em; margin-left: 8px; }
    
    .admin-section {
      background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
      color: white; padding: 25px; border-radius: 15px; margin: 30px 0;
      box-shadow: 0 15px 30px rgba(0,0,0,0.2);
    }
    
    .admin-section h3, .admin-section h4 { 
      color: #63b3ed; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    .admin-list {
      background: rgba(255,255,255,0.05); border-radius: 10px; 
      padding: 15px; margin: 15px 0; max-height: 200px; overflow-y: auto;
    }
    
    .admin-list li {
      padding: 10px; margin: 8px 0; background: rgba(255,255,255,0.1);
      border-radius: 8px; display: flex; justify-content: space-between; align-items: center;
    }
    
    .status-msg { 
      margin-left: 15px; font-weight: 600; 
      animation: fadeIn 0.5s ease;
    }
    
    .error-msg { color: #fc8181; }
    .success-msg { color: #68d391; }
    
    .section-title {
      font-size: 1.5em; font-weight: 700; margin: 30px 0 15px 0;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; color: transparent;
    }
    
    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px; margin: 20px 0;
    }
    
    .stat-card {
      background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px;
      text-align: center; backdrop-filter: blur(5px);
    }
    
    .stat-number { font-size: 2em; font-weight: bold; color: #63b3ed; }
    .stat-label { color: #a0aec0; font-size: 0.9em; }
    
    .online-indicator {
      display: inline-block; width: 8px; height: 8px;
      background: #48bb78; border-radius: 50%; margin-right: 8px;
      animation: blink 2s infinite;
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .now-playing {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; padding: 20px; border-radius: 15px; margin: 20px 0;
      text-align: center; box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }
    
    .track-info { font-size: 1.2em; font-weight: 600; margin-bottom: 10px; }
    .track-artist { opacity: 0.9; }
    
    @media (max-width: 768px) {
      .player-container { margin: 10px; padding: 20px; }
      .form-group { flex-direction: column; }
      .input { margin-bottom: 10px; }
      .video-container iframe { height: 250px; }
    }
  </style>
</head>
<body>
  <div class="player-container" id="playerContainer">
    <div class="logo">üéµ StreamVibe</div>

    <!-- Login Section -->
    <div id="loginSection" class="auth-section">
      <h3 style="margin-top:0;">Welcome Back!</h3>
      <div class="form-group">
        <input id="loginUsername" class="input" placeholder="Username">
        <input id="loginPassword" class="input" type="password" placeholder="Password">
        <button id="loginBtn" class="btn">Login</button>
        <button id="showSignupBtn" class="link-btn">Create Account</button>
      </div>
      <div id="loginError" class="error-msg" style="margin-top:10px;"></div>
    </div>

    <!-- Signup Section -->
    <div id="signupSection" class="auth-section" style="display:none;">
      <h3 style="margin-top:0;">Join StreamVibe!</h3>
      <div class="form-group">
        <input id="signupUsername" class="input" placeholder="Choose Username">
        <input id="signupPassword" class="input" type="password" placeholder="Create Password">
        <input id="signupEmail" class="input" placeholder="Email (optional)">
        <button id="signupBtn" class="btn">Sign Up</button>
        <button id="showLoginBtn" class="link-btn">Back to Login</button>
      </div>
      <div id="signupError" class="error-msg" style="margin-top:10px;"></div>
      <div id="signupSuccess" class="success-msg" style="margin-top:10px;"></div>
    </div>

    <!-- User Section -->
    <div id="userSection" class="user-section" style="display:none;">
      <div>
        <span class="online-indicator"></span>
        <span id="welcomeMsg" class="welcome-msg"></span>
      </div>
      <button id="logoutBtn" class="btn btn-sm">Logout</button>
    </div>

    <!-- Broadcast Message -->
    <div id="broadcastMsg" class="broadcast-msg" style="display:none;"></div>

    <!-- Now Playing Section -->
    <div class="now-playing" id="nowPlayingSection" style="display:none;">
      <div class="track-info" id="trackInfo">No track selected</div>
      <div class="track-artist" id="trackArtist">Select a song to start playing</div>
    </div>

    <!-- Video Player -->
    <div class="video-container">
      <iframe id="videoPlayer" src="" allowfullscreen></iframe>
    </div>

    <!-- Playlist Section -->
    <div>
      <h3 class="section-title">üéµ Playlist</h3>
      <div id="playlistContainer" class="playlist-container"></div>
    </div>

    <!-- Song Request Section (Regular Users) -->
    <div id="requestSongSection" class="song-section" style="display:none;">
      <h4>üé§ Request a Song</h4>
      <div class="form-group">
        <input id="requestSongInput" class="input" placeholder="Paste YouTube link or song title">
        <button id="requestSongBtn" class="btn">Send Request</button>
      </div>
      <span id="requestStatus" class="success-msg"></span>
    </div>

    <!-- Add Song Section (Admin Only) -->
    <div id="addSongSection" class="song-section" style="display:none;">
      <h4>‚ûï Add Song to Playlist</h4>
      <div class="form-group">
        <input id="youtubeUrl" class="input" placeholder="YouTube URL">
        <button id="addUrlBtn" class="btn">Add to Playlist</button>
      </div>
    </div>

    <!-- Chat Section -->
    <div class="chat-section">
      <h4>üí¨ Chat with Admin</h4>
      <div id="chatBox" class="chat-box"></div>
      <div class="form-group">
        <input id="chatInput" class="input" placeholder="Type your message...">
        <button id="chatSendBtn" class="btn btn-sm">Send</button>
      </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminSection" class="admin-section" style="display:none;">
      <h3>üõ†Ô∏è Admin Dashboard</h3>
      
      <!-- Stats Overview -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalUsers">0</div>
          <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalSongs">0</div>
          <div class="stat-label">Songs in Playlist</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="pendingRequests">0</div>
          <div class="stat-label">Pending Requests</div>
        </div>
      </div>

      <!-- User Management -->
      <div>
        <h4>üë• User Management</h4>
        <ul id="userList" class="admin-list"></ul>
      </div>

      <!-- Playlist Management -->
      <div>
        <h4>üéµ Playlist Management</h4>
        <div class="form-group" style="margin-bottom:15px;">
          <button id="shuffleBtn" class="btn btn-sm">üîÄ Shuffle Playlist</button>
          <button id="clearPlaylistBtn" class="btn btn-danger btn-sm">üóëÔ∏è Clear All</button>
        </div>
        <ul id="adminPlaylist" class="admin-list"></ul>
      </div>

      <!-- Song Requests -->
      <div>
        <h4>üé§ Pending Song Requests</h4>
        <ul id="adminRequests" class="admin-list"></ul>
      </div>

      <!-- Chat Management -->
      <div>
        <h4>üí¨ User Chats</h4>
        <select id="adminChatSelect" class="input" style="margin-bottom:15px;"></select>
        <div id="adminChatBox" class="chat-box"></div>
        <div class="form-group">
          <input id="adminChatInput" class="input" placeholder="Reply to user...">
          <button id="adminChatSendBtn" class="btn btn-sm">Send</button>
        </div>
      </div>

      <!-- Broadcast Message -->
      <div style="margin-top:25px;">
        <h4>üì¢ Broadcast to All Users</h4>
        <div class="form-group">
          <input id="broadcastInput" class="input" placeholder="Message for all users">
          <button id="broadcastBtn" class="btn btn-success btn-sm">Broadcast</button>
          <button id="clearBroadcastBtn" class="btn btn-danger btn-sm">Clear</button>
        </div>
        <span id="broadcastStatus" class="success-msg"></span>
      </div>
    </div>
  </div>

  <script>
    // --- Enhanced Demo Data ---
    let users = [
      { username: 'admin', password: 'admin', email: 'admin@streamvibe.com', joinDate: new Date('2024-01-01') },
      { username: 'alice', password: 'alice', email: 'alice@email.com', joinDate: new Date('2024-06-15') },
      { username: 'bob', password: 'bob', email: 'bob@email.com', joinDate: new Date('2024-08-20') },
      { username: 'charlie', password: 'charlie', email: 'charlie@music.com', joinDate: new Date('2024-08-25') }
    ];
    
    let playlist = [
      { id: 'dQw4w9WgXcQ', title: 'Rick Astley - Never Gonna Give You Up', addedBy: 'admin', addedAt: new Date() },
      { id: 'kJQP7kiw5Fk', title: 'Luis Fonsi - Despacito ft. Daddy Yankee', addedBy: 'alice', addedAt: new Date() }
    ];
    
    let currentTrack = 0;
    let currentUser = null;
    let broadcastMessage = '';
    let songRequests = [];
    let chatMessages = {};

    // --- DOM Elements ---
    const loginSection = document.getElementById('loginSection');
    const signupSection = document.getElementById('signupSection');
    const userSection = document.getElementById('userSection');
    const adminSection = document.getElementById('adminSection');
    const nowPlayingSection = document.getElementById('nowPlayingSection');
    const broadcastMsg = document.getElementById('broadcastMsg');
    const playlistContainer = document.getElementById('playlistContainer');
    const videoPlayer = document.getElementById('videoPlayer');
    
    // Auth elements
    const loginBtn = document.getElementById('loginBtn');
    const loginUsername = document.getElementById('loginUsername');
    const loginPassword = document.getElementById('loginPassword');
    const loginError = document.getElementById('loginError');
    const signupBtn = document.getElementById('signupBtn');
    const signupUsername = document.getElementById('signupUsername');
    const signupPassword = document.getElementById('signupPassword');
    const signupEmail = document.getElementById('signupEmail');
    const showSignupBtn = document.getElementById('showSignupBtn');
    const showLoginBtn = document.getElementById('showLoginBtn');
    const signupError = document.getElementById('signupError');
    const signupSuccess = document.getElementById('signupSuccess');
    const welcomeMsg = document.getElementById('welcomeMsg');
    const logoutBtn = document.getElementById('logoutBtn');

    // Song management
    const addUrlBtn = document.getElementById('addUrlBtn');
    const youtubeUrl = document.getElementById('youtubeUrl');
    const addSongSection = document.getElementById('addSongSection');
    const requestSongSection = document.getElementById('requestSongSection');
    const requestSongInput = document.getElementById('requestSongInput');
    const requestSongBtn = document.getElementById('requestSongBtn');
    const requestStatus = document.getElementById('requestStatus');

    // Chat elements
    const chatBox = document.getElementById('chatBox');
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');

    // Admin elements
    const userList = document.getElementById('userList');
    const adminPlaylist = document.getElementById('adminPlaylist');
    const adminRequests = document.getElementById('adminRequests');
    const adminChatSelect = document.getElementById('adminChatSelect');
    const adminChatBox = document.getElementById('adminChatBox');
    const adminChatInput = document.getElementById('adminChatInput');
    const adminChatSendBtn = document.getElementById('adminChatSendBtn');
    const broadcastInput = document.getElementById('broadcastInput');
    const broadcastBtn = document.getElementById('broadcastBtn');
    const clearBroadcastBtn = document.getElementById('clearBroadcastBtn');
    const broadcastStatus = document.getElementById('broadcastStatus');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const clearPlaylistBtn = document.getElementById('clearPlaylistBtn');

    // Stats elements
    const totalUsers = document.getElementById('totalUsers');
    const totalSongs = document.getElementById('totalSongs');
    const pendingRequests = document.getElementById('pendingRequests');
    const trackInfo = document.getElementById('trackInfo');
    const trackArtist = document.getElementById('trackArtist');

    // --- Utility Functions ---
    function showStatus(element, message, isError = false) {
      element.textContent = message;
      element.className = isError ? 'error-msg' : 'success-msg';
      setTimeout(() => element.textContent = '', 3000);
    }

    function formatTime(date) {
      return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function extractYouTubeTitle(url) {
      // In a real app, you'd fetch the title via YouTube API
      // For demo, we'll extract from common patterns or use generic title
      return 'YouTube Video';
    }

    function getYouTubeId(url) {
      const match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?(?:.*&)?v=|embed\/|v\/))([\w-]{11})/);
      return match ? match[1] : null;
    }

    // --- Authentication ---
    showSignupBtn.onclick = () => {
      loginSection.style.display = 'none';
      signupSection.style.display = '';
      clearErrors();
    };

    showLoginBtn.onclick = () => {
      loginSection.style.display = '';
      signupSection.style.display = 'none';
      clearErrors();
    };

    function clearErrors() {
      loginError.textContent = '';
      signupError.textContent = '';
      signupSuccess.textContent = '';
    }

    signupBtn.onclick = () => {
      const username = signupUsername.value.trim();
      const password = signupPassword.value.trim();
      const email = signupEmail.value.trim();
      
      if (!username || !password) {
        showStatus(signupError, 'Username and password are required.', true);
        return;
      }
      
      if (username.length < 3) {
        showStatus(signupError, 'Username must be at least 3 characters.', true);
        return;
      }
      
      if (users.find(u => u.username === username)) {
        showStatus(signupError, 'Username already exists.', true);
        return;
      }
      
      users.push({ 
        username, 
        password, 
        email, 
        joinDate: new Date() 
      });
      
      showStatus(signupSuccess, 'Account created successfully! You can now login.');
      signupUsername.value = '';
      signupPassword.value = '';
      signupEmail.value = '';
      
      setTimeout(() => {
        loginSection.style.display = '';
        signupSection.style.display = 'none';
      }, 2000);
    };

    loginBtn.onclick = () => {
      const username = loginUsername.value.trim();
      const password = loginPassword.value.trim();
      
      const user = users.find(u => u.username === username && u.password === password);
      if (!user) {
        showStatus(loginError, 'Invalid username or password.', true);
        return;
      }
      
      currentUser = user;
      // Note: Using in-memory storage instead of localStorage for demo
      loginSection.style.display = 'none';
      signupSection.style.display = 'none';
      userSection.style.display = '';
      welcomeMsg.textContent = `Welcome back, ${currentUser.username}!`;
      showUserInterface();
    };

    logoutBtn.onclick = () => {
      currentUser = null;
      loginSection.style.display = '';
      userSection.style.display = 'none';
      adminSection.style.display = 'none';
      addSongSection.style.display = 'none';
      requestSongSection.style.display = 'none';
      broadcastMsg.style.display = 'none';
      nowPlayingSection.style.display = 'none';
      renderPlaylist();
      chatBox.innerHTML = '';
      clearErrors();
    };

    function showUserInterface() {
      if (!currentUser) return;
      
      if (currentUser.username === 'admin') {
        addSongSection.style.display = '';
        requestSongSection.style.display = 'none';
        adminSection.style.display = 'block';
        updateAdminStats();
        renderUserList();
        renderAdminPlaylist();
        renderRequests();
        renderAdminChatSelect();
        renderAdminChat();
      } else {
        addSongSection.style.display = 'none';
        requestSongSection.style.display = '';
        adminSection.style.display = 'none';
        renderChat();
      }
      
      renderPlaylist();
      showBroadcastMessage();
      updateNowPlaying();
    }

    function showBroadcastMessage() {
      if (broadcastMessage && currentUser) {
        broadcastMsg.style.display = 'block';
        broadcastMsg.textContent = `üì¢ Admin: ${broadcastMessage}`;
      } else {
        broadcastMsg.style.display = 'none';
      }
    }

    function updateNowPlaying() {
      if (playlist.length > 0 && currentTrack < playlist.length) {
        nowPlayingSection.style.display = '';
        trackInfo.textContent = playlist[currentTrack].title;
        trackArtist.textContent = `Added by ${playlist[currentTrack].addedBy}`;
      } else {
        nowPlayingSection.style.display = 'none';
      }
    }

    // --- Playlist Management ---
    addUrlBtn.onclick = () => {
      const url = youtubeUrl.value.trim();
      if (!url) return;
      
      const id = getYouTubeId(url);
      if (!id) {
        alert('Please enter a valid YouTube URL');
        return;
      }
      
      const title = extractYouTubeTitle(url);
      playlist.push({
        id, 
        title, 
        addedBy: currentUser.username,
        addedAt: new Date()
      });
      
      youtubeUrl.value = '';
      renderPlaylist();
      renderAdminPlaylist();
      updateAdminStats();
      updateNowPlaying();
      
      // Auto-play if this is the first song
      if (playlist.length === 1) {
        playTrack(0);
      }
    };

    function renderPlaylist() {
      playlistContainer.innerHTML = '';
      
      if (playlist.length === 0) {
        playlistContainer.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">No songs in playlist yet</div>';
        return;
      }
      
      playlist.forEach((track, i) => {
        const div = document.createElement('div');
        div.className = 'playlist-item' + (i === currentTrack ? ' active' : '');
        div.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div style="font-weight:600;">${track.title}</div>
              <div style="font-size:0.9em; opacity:0.7;">Added by ${track.addedBy}</div>
            </div>
            <div style="font-size:0.8em; opacity:0.6;">
              ${track.addedAt ? formatTime(track.addedAt) : ''}
            </div>
          </div>
        `;
        
        // Only admin can control playback
        if (currentUser && currentUser.username === 'admin') {
          div.onclick = () => playTrack(i);
          div.style.cursor = 'pointer';
        } else {
          div.style.cursor = 'default';
        }
        
        playlistContainer.appendChild(div);
      });
    }

    function playTrack(idx) {
      if (!playlist[idx] || !currentUser || currentUser.username !== 'admin') return;
      currentTrack = idx;
      videoPlayer.src = `https://www.youtube.com/embed/${playlist[idx].id}?autoplay=1`;
      renderPlaylist();
      updateNowPlaying();
    }

    // --- Song Requests ---
    requestSongBtn.onclick = () => {
      const request = requestSongInput.value.trim();
      if (!request || !currentUser) return;
      
      songRequests.push({
        user: currentUser.username,
        request: request,
        timestamp: new Date()
      });
      
      showStatus(requestStatus, 'Request sent successfully!');
      requestSongInput.value = '';
      renderRequests();
      updateAdminStats();
    };

    function renderRequests() {
      if (!adminRequests) return;
      adminRequests.innerHTML = '';
      
      if (songRequests.length === 0) {
        adminRequests.innerHTML = '<li style="opacity:0.6;">No pending requests</li>';
        return;
      }
      
      songRequests.forEach((sr, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div>
            <strong>${sr.user}</strong>: ${sr.request}
            <div style="font-size:0.8em; opacity:0.7;">${formatTime(sr.timestamp)}</div>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="btn btn-success btn-sm" onclick="approveRequest(${idx})">‚úì Add</button>
            <button class="btn btn-danger btn-sm" onclick="dismissRequest(${idx})">‚úó Dismiss</button>
          </div>
        `;
        adminRequests.appendChild(li);
      });
    }

    function approveRequest(idx) {
      const request = songRequests[idx];
      const id = getYouTubeId(request.request);
      
      playlist.push({
        id: id || '',
        title: id ? extractYouTubeTitle(request.request) : request.request,
        addedBy: request.user,
        addedAt: new Date()
      });
      
      songRequests.splice(idx, 1);
      renderRequests();
      renderAdminPlaylist();
      renderPlaylist();
      updateAdminStats();
      updateNowPlaying();
    }

    function dismissRequest(idx) {
      songRequests.splice(idx, 1);
      renderRequests();
      updateAdminStats();
    }

    // --- Admin Functions ---
    function updateAdminStats() {
      if (totalUsers) totalUsers.textContent = users.filter(u => u.username !== 'admin').length;
      if (totalSongs) totalSongs.textContent = playlist.length;
      if (pendingRequests) pendingRequests.textContent = songRequests.length;
    }

    function renderUserList() {
      userList.innerHTML = '';
      users.forEach((user, idx) => {
        if (user.username === 'admin') return;
        
        const li = document.createElement('li');
        li.innerHTML = `
          <div>
            <strong>${user.username}</strong> (${user.email || 'no email'})
            <div style="font-size:0.8em; opacity:0.7;">Joined: ${user.joinDate ? user.joinDate.toLocaleDateString() : 'Unknown'}</div>
          </div>
          <button class="btn btn-danger btn-sm" onclick="deleteUser(${idx})">Delete</button>
        `;
        userList.appendChild(li);
      });
    }

    function deleteUser(idx) {
      const user = users[idx];
      if (confirm(`Delete user "${user.username}"?`)) {
        users.splice(idx, 1);
        renderUserList();
        updateAdminStats();
        renderAdminChatSelect();
      }
    }

    function renderAdminPlaylist() {
      adminPlaylist.innerHTML = '';
      
      if (playlist.length === 0) {
        adminPlaylist.innerHTML = '<li style="opacity:0.6;">No songs in playlist</li>';
        return;
      }
      
      playlist.forEach((track, i) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div>
            <strong>${track.title}</strong>
            <div style="font-size:0.8em; opacity:0.7;">Added by ${track.addedBy} ‚Ä¢ ${track.addedAt ? formatTime(track.addedAt) : ''}</div>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="btn btn-sm" onclick="playTrack(${i})">‚ñ∂ Play</button>
            <button class="btn btn-danger btn-sm" onclick="removeFromPlaylist(${i})">Remove</button>
          </div>
        `;
        adminPlaylist.appendChild(li);
      });
    }

    function removeFromPlaylist(idx) {
      playlist.splice(idx, 1);
      if (currentTrack >= playlist.length) {
        currentTrack = 0;
      }
      renderAdminPlaylist();
      renderPlaylist();
      updateAdminStats();
      updateNowPlaying();
      
      if (playlist.length === 0) {
        videoPlayer.src = '';
      } else if (idx <= currentTrack) {
        playTrack(currentTrack);
      }
    }

    // --- New Admin Features ---
    shuffleBtn.onclick = () => {
      if (playlist.length === 0) return;
      
      // Simple shuffle algorithm
      for (let i = playlist.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [playlist[i], playlist[j]] = [playlist[j], playlist[i]];
      }
      
      currentTrack = 0;
      renderPlaylist();
      renderAdminPlaylist();
      if (playlist.length > 0) {
        playTrack(0);
      }
    };

    clearPlaylistBtn.onclick = () => {
      if (confirm('Clear entire playlist? This cannot be undone.')) {
        playlist = [];
        currentTrack = 0;
        videoPlayer.src = '';
        renderPlaylist();
        renderAdminPlaylist();
        updateAdminStats();
        updateNowPlaying();
      }
    };

    // --- Broadcast Management ---
    broadcastBtn.onclick = () => {
      broadcastMessage = broadcastInput.value.trim();
      showBroadcastMessage();
      showStatus(broadcastStatus, 'Broadcast sent to all users!');
      broadcastInput.value = '';
    };

    clearBroadcastBtn.onclick = () => {
      broadcastMessage = '';
      broadcastMsg.style.display = 'none';
      showStatus(broadcastStatus, 'Broadcast message cleared.');
    };

    // --- Chat System ---
    function renderChat() {
      if (!currentUser) return;
      chatBox.innerHTML = '';
      const msgs = chatMessages[currentUser.username] || [];
      
      if (msgs.length === 0) {
        chatBox.innerHTML = '<div style="text-align:center; opacity:0.6; padding:20px;">No messages yet. Start a conversation!</div>';
        return;
      }
      
      msgs.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'chat-msg';
        const time = msg.timestamp ? formatTime(msg.timestamp) : '';
        
        if (msg.sender === 'admin') {
          div.innerHTML = `<span class="chat-user chat-admin">Admin:</span> ${msg.text} <span class="chat-timestamp">${time}</span>`;
        } else {
          div.innerHTML = `<span class="chat-user">${msg.sender}:</span> ${msg.text} <span class="chat-timestamp">${time}</span>`;
        }
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    chatSendBtn.onclick = sendChatMessage;
    chatInput.onkeypress = (e) => {
      if (e.key === 'Enter') sendChatMessage();
    };

    function sendChatMessage() {
      if (!currentUser) return;
      const text = chatInput.value.trim();
      if (!text) return;
      
      if (!chatMessages[currentUser.username]) {
        chatMessages[currentUser.username] = [];
      }
      
      chatMessages[currentUser.username].push({
        sender: currentUser.username,
        text: text,
        timestamp: new Date()
      });
      
      chatInput.value = '';
      renderChat();
      renderAdminChat();
      renderAdminChatSelect(); // Update chat select to show activity
    }

    // --- Admin Chat Management ---
    function renderAdminChatSelect() {
      adminChatSelect.innerHTML = '<option value="">Select a user to chat with</option>';
      users.forEach(u => {
        if (u.username === 'admin') return;
        const option = document.createElement('option');
        option.value = u.username;
        const msgCount = chatMessages[u.username] ? chatMessages[u.username].length : 0;
        const hasNewMsgs = msgCount > 0 ? ' üí¨' : '';
        option.textContent = `${u.username}${hasNewMsgs} (${msgCount} messages)`;
        adminChatSelect.appendChild(option);
      });
    }

    adminChatSelect.onchange = renderAdminChat;

    function renderAdminChat() {
      const username = adminChatSelect.value;
      adminChatBox.innerHTML = '';
      
      if (!username) {
        adminChatBox.innerHTML = '<div style="text-align:center; opacity:0.6; padding:20px;">Select a user to view chat history</div>';
        return;
      }
      
      const msgs = chatMessages[username] || [];
      if (msgs.length === 0) {
        adminChatBox.innerHTML = '<div style="text-align:center; opacity:0.6; padding:20px;">No conversation with this user yet</div>';
        return;
      }
      
      msgs.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'chat-msg';
        const time = msg.timestamp ? formatTime(msg.timestamp) : '';
        
        if (msg.sender === 'admin') {
          div.innerHTML = `<span class="chat-user chat-admin">Admin:</span> ${msg.text} <span class="chat-timestamp">${time}</span>`;
        } else {
          div.innerHTML = `<span class="chat-user">${msg.sender}:</span> ${msg.text} <span class="chat-timestamp">${time}</span>`;
        }
        adminChatBox.appendChild(div);
      });
      adminChatBox.scrollTop = adminChatBox.scrollHeight;
    }

    adminChatSendBtn.onclick = sendAdminMessage;
    adminChatInput.onkeypress = (e) => {
      if (e.key === 'Enter') sendAdminMessage();
    };

    function sendAdminMessage() {
      const username = adminChatSelect.value;
      if (!username) return;
      
      const text = adminChatInput.value.trim();
      if (!text) return;
      
      if (!chatMessages[username]) {
        chatMessages[username] = [];
      }
      
      chatMessages[username].push({
        sender: 'admin',
        text: text,
        timestamp: new Date()
      });
      
      adminChatInput.value = '';
      renderAdminChat();
      
      // If this user is currently logged in, update their chat view
      if (currentUser && currentUser.username === username) {
        renderChat();
      }
    }

    // --- Auto-start and Initial Setup ---
    function initialize() {
      // Auto-play first track if admin and playlist exists
      if (playlist.length > 0) {
        updateNowPlaying();
      }
      
      // Initialize stats
      updateAdminStats();
      
      // Add some sample chat messages for demo
      chatMessages['alice'] = [
        { sender: 'alice', text: 'Hey! Love the new playlist feature!', timestamp: new Date(Date.now() - 3600000) },
        { sender: 'admin', text: 'Thanks Alice! Let me know if you have any requests.', timestamp: new Date(Date.now() - 3500000) }
      ];
      
      chatMessages['bob'] = [
        { sender: 'bob', text: 'Can you add some jazz music?', timestamp: new Date(Date.now() - 1800000) }
      ];
      
      // Add some sample requests
      songRequests.push({
        user: 'alice',
        request: 'https://www.youtube.com/watch?v=9bZkp7q19f0',
        timestamp: new Date(Date.now() - 900000)
      });
      
      songRequests.push({
        user: 'bob',
        request: 'Some good jazz music please',
        timestamp: new Date(Date.now() - 600000)
      });
    }

    // --- Enhanced Error Handling ---
    window.onerror = function(msg, url, line, col, error) {
      console.error('Application error:', msg, 'at line', line);
      return false;
    };

    // --- Keyboard Shortcuts ---
    document.addEventListener('keydown', (e) => {
      if (!currentUser || currentUser.username !== 'admin') return;
      
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case 'ArrowRight':
            e.preventDefault();
            if (currentTrack < playlist.length - 1) {
              playTrack(currentTrack + 1);
            }
            break;
          case 'ArrowLeft':
            e.preventDefault();
            if (currentTrack > 0) {
              playTrack(currentTrack - 1);
            }
            break;
        }
      }
    });

    // --- Auto-initialization ---
    // Try to restore previous session (in real app this would use localStorage)
    function tryAutoLogin() {
      // For demo purposes, we'll skip auto-login
      // In production: const storedUser = localStorage.getItem('currentUser');
      initialize();
    }

    // --- Initialize App ---
    tryAutoLogin();
    
    // Add some visual feedback for interactions
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('btn')) {
        e.target.style.transform = 'scale(0.95)';
        setTimeout(() => {
          e.target.style.transform = '';
        }, 150);
      }
    });

    // Make functions globally accessible for onclick handlers
    window.approveRequest = approveRequest;
    window.dismissRequest = dismissRequest;
    window.deleteUser = deleteUser;
    window.removeFromPlaylist = removeFromPlaylist;
    window.playTrack = playTrack;
  </script>
</body>
</html>
